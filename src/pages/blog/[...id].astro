---
import PostPageContent from '@/components/PostPageContent.astro'
import {
  getAdjacentPosts,
  getAllPostsAndSubposts,
  getCombinedReadingTime,
  getParentId,
  getParentPost,
  getPostReadingTime,
  getSubpostCount,
  getTOCSections,
  hasSubposts,
  isSubpost,
  parseAuthors,
} from '@/lib/collections'
import { render } from 'astro:content'

export async function getStaticPaths() {
  const posts = await getAllPostsAndSubposts()
  return posts.map((post) => ({
    params: { id: post.id },
    props: post,
  }))
}

const post = Astro.props
const currentPostId = Astro.params.id
const { Content, headings } = await render(post)
const authors = await parseAuthors(post.data.authors ?? [])

const isCurrentSubpost = isSubpost(currentPostId)
const navigation = await getAdjacentPosts(currentPostId)
const parentPost = isCurrentSubpost ? await getParentPost(currentPostId) : null

const hasChildPosts = await hasSubposts(currentPostId)
const subpostCount = !isCurrentSubpost
  ? await getSubpostCount(currentPostId)
  : 0
const postReadingTime = await getPostReadingTime(currentPostId)
const combinedReadingTime =
  hasChildPosts && !isCurrentSubpost
    ? await getCombinedReadingTime(currentPostId)
    : null

const tocSections = await getTOCSections(currentPostId)
---

<PostPageContent
  post={post}
  collection="blog"
  basePath="/blog"
  currentPostId={currentPostId}
  Content={Content}
  headings={headings}
  authors={authors}
  isCurrentSubpost={isCurrentSubpost}
  parentPost={parentPost}
  hasChildPosts={hasChildPosts}
  subpostCount={subpostCount}
  postReadingTime={postReadingTime}
  combinedReadingTime={combinedReadingTime}
  tocSections={tocSections}
  navigation={navigation}
  getParentId={getParentId}
/>
