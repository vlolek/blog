---
import Link from '@/components/Link.astro'
import { ScrollArea } from '@/components/ui/scroll-area'
import type { PostCollection } from '@/lib/collections'
import { Icon } from 'astro-icon/components'

interface Props {
  parentId: string
  basePath: string
  collection: PostCollection
  className?: string
}

const {
  parentId,
  basePath,
  collection,
  className,
} = Astro.props
const currentPostId = Astro.params.id as string

// Importa le funzioni corrette in base alla collection
let isSubpostFn: (id: string) => boolean
let getParentIdFn: (id: string) => string
let getByIdFn: (id: string) => Promise<any>
let getSubpostsForParentFn: (
  id: string,
) => Promise<any[]>
let getParentPostFn: (id: string) => Promise<any>
let getReadingTimeFn: (
  id: string,
) => Promise<string>
let getCombinedReadingTimeFn: (
  id: string,
) => Promise<string>

if (collection === 'blog') {
  const {
    isSubpost,
    getParentId,
    getPostById,
    getSubpostsForParent,
    getParentPost,
    getPostReadingTime,
    getCombinedReadingTime,
  } = await import('@/lib/collections')
  isSubpostFn = isSubpost
  getParentIdFn = getParentId
  getByIdFn = getPostById
  getSubpostsForParentFn = getSubpostsForParent
  getParentPostFn = getParentPost
  getReadingTimeFn = getPostReadingTime
  getCombinedReadingTimeFn =
    getCombinedReadingTime
} else if (collection === 'education') {
  const {
    isEducationSubpost,
    getEducationParentId,
    getEducationById,
    getEducationSubpostsForParent,
    getEducationParentPost,
    getEducationReadingTime,
    getEducationCombinedReadingTime,
  } = await import('@/lib/collections')
  isSubpostFn = isEducationSubpost
  getParentIdFn = getEducationParentId
  getByIdFn = getEducationById
  getSubpostsForParentFn =
    getEducationSubpostsForParent
  getParentPostFn = getEducationParentPost
  getReadingTimeFn = getEducationReadingTime
  getCombinedReadingTimeFn =
    getEducationCombinedReadingTime
}

const isCurrentSubpost = isSubpostFn(
  currentPostId || parentId,
)
const rootParentId = isCurrentSubpost
  ? getParentIdFn(currentPostId || parentId)
  : parentId

const currentPost = !isCurrentSubpost
  ? await getByIdFn(currentPostId || parentId)
  : null
const subposts =
  await getSubpostsForParentFn(rootParentId)
const parentPost = isCurrentSubpost
  ? await getParentPostFn(
      currentPostId || parentId,
    )
  : null

const activePost = parentPost || currentPost
const isActivePost =
  activePost?.id === (currentPostId || parentId)

const activePostReadingTime = activePost
  ? await getReadingTimeFn(activePost.id)
  : null
const activePostCombinedReadingTime =
  activePost && subposts.length > 0
    ? await getCombinedReadingTimeFn(
        activePost.id,
      )
    : null
const subpostsWithReadingTime = await Promise.all(
  subposts.map(async (subpost) => ({
    ...subpost,
    readingTime: await getReadingTimeFn(
      subpost.id,
    ),
  })),
)

// Configurazione per collection
const config = {
  blog: {
    ariaLabel: "Lista dei capitoli dell'articolo",
    parentIcon: 'lucide:book-open-text',
    parentLinkIcon: 'lucide:book-open',
    subpostIcon: 'lucide:file-text',
    subpostLinkIcon: 'lucide:file',
    parentAriaLabel: (title: string) =>
      `Vai al post principale: ${title}`,
    subpostAriaLabel: (title: string) =>
      `Vai al capitolo: ${title}`,
    colStart: 'col-start-3',
    margin: 'mr-auto ml-8',
  },
  education: {
    ariaLabel:
      "Lista dei capitoli dell'articolo di formazione",
    parentIcon: 'lucide:book-open-text',
    parentLinkIcon: 'lucide:book-open',
    subpostIcon: 'lucide:file-text',
    subpostLinkIcon: 'lucide:file',
    parentAriaLabel: (title: string) =>
      `Vai al post principale: ${title}`,
    subpostAriaLabel: (title: string) =>
      `Vai al capitolo: ${title}`,
    colStart: 'col-start-3',
    margin: 'mr-auto ml-8',
  },
}

const cfg = config[collection as keyof typeof config]
---

<div
  id="subposts-sidebar-container"
  class={`sticky top-20 ${cfg.colStart} row-span-1 ${cfg.margin} hidden h-[calc(100vh-5rem)] max-w-md xl:block ${className || ''}`}
>
  <ScrollArea
    client:load
    className="flex max-h-[calc(100vh-8rem)] flex-col overflow-y-auto"
    data-subposts-sidebar-scroll
  >
    <div class="px-4">
      <ul
        class="space-y-1"
        aria-label={cfg.ariaLabel}
      >
        {
          activePost && (
            <li>
              {isActivePost ? (
                <div class="text-foreground bg-muted subposts-sidebar-active-item flex items-center gap-2 py-1.5 pr-3 pl-2 text-sm font-medium text-pretty">
                  <Icon
                    name={cfg.parentIcon}
                    class="size-4 flex-shrink-0"
                    aria-hidden="true"
                  />
                  <div class="flex flex-col">
                    <span class="line-clamp-2 text-pretty">
                      {activePost.data.title}
                    </span>
                    {activePostReadingTime && (
                      <span class="text-muted-foreground/80 text-xs">
                        {activePostReadingTime}
                        {activePostCombinedReadingTime &&
                          activePostCombinedReadingTime !==
                            activePostReadingTime && (
                            <span>
                              {' '}
                              (
                              {
                                activePostCombinedReadingTime
                              }{' '}
                              total)
                            </span>
                          )}
                      </span>
                    )}
                  </div>
                </div>
              ) : (
                <Link
                  href={`${basePath}/${activePost.id}#post-title`}
                  class="hover:text-foreground text-muted-foreground hover:bg-muted/50 subposts-sidebar-link flex items-center gap-2 px-2 py-1.5 text-sm text-pretty transition-colors"
                  aria-label={cfg.parentAriaLabel(
                    activePost.data.title,
                  )}
                >
                  <Icon
                    name={cfg.parentLinkIcon}
                    class="size-4 flex-shrink-0"
                    aria-hidden="true"
                  />
                  <div class="flex flex-col">
                    <span class="line-clamp-2 text-pretty">
                      {activePost.data.title}
                    </span>
                    {activePostReadingTime && (
                      <span class="text-muted-foreground/80 text-xs">
                        {activePostReadingTime}
                        {activePostCombinedReadingTime &&
                          activePostCombinedReadingTime !==
                            activePostReadingTime && (
                            <span>
                              {' '}
                              (
                              {
                                activePostCombinedReadingTime
                              }{' '}
                              total)
                            </span>
                          )}
                      </span>
                    )}
                  </div>
                </Link>
              )}
            </li>
          )
        }

        {
          subpostsWithReadingTime.length > 0 && (
            <li class="ml-4 space-y-1">
              {subpostsWithReadingTime.map(
                (subpost) =>
                  (currentPostId ||
                    parentId) === subpost.id ? (
                    <div class="text-foreground bg-muted subposts-sidebar-active-item flex items-center gap-2 px-2 py-1.5 text-sm font-medium text-pretty">
                      <Icon
                        name={cfg.subpostIcon}
                        class="size-4 flex-shrink-0"
                        aria-hidden="true"
                      />
                      <div class="flex flex-col">
                        <span class="line-clamp-2 text-pretty">
                          {subpost.data.title}
                        </span>
                        <span class="text-muted-foreground/80 text-xs">
                          {subpost.readingTime}
                        </span>
                      </div>
                    </div>
                  ) : (
                    <Link
                      href={`${basePath}/${subpost.id}`}
                      class="hover:text-foreground text-muted-foreground hover:bg-muted/50 subposts-sidebar-link flex items-center gap-2 px-2 py-1.5 text-sm text-pretty transition-colors"
                      aria-label={cfg.subpostAriaLabel(
                        subpost.data.title,
                      )}
                    >
                      <Icon
                        name={
                          cfg.subpostLinkIcon
                        }
                        class="size-4 flex-shrink-0"
                        aria-hidden="true"
                      />
                      <div class="flex flex-col">
                        <span class="line-clamp-2 text-pretty">
                          {subpost.data.title}
                        </span>
                        <span class="text-muted-foreground/80 text-xs">
                          {subpost.readingTime}
                        </span>
                      </div>
                    </Link>
                  ),
              )}
            </li>
          )
        }
      </ul>
    </div>
  </ScrollArea>
</div>

<script>
  class SidebarState {
    scrollArea: HTMLElement | null = null
    sidebarScrollArea: HTMLElement | null = null

    reset() {
      this.scrollArea = null
      this.sidebarScrollArea = null
    }
  }

  const state = new SidebarState()

  class SidebarScrollMask {
    static update() {
      if (
        !state.scrollArea ||
        !state.sidebarScrollArea
      )
        return

      const {
        scrollTop,
        scrollHeight,
        clientHeight,
      } = state.scrollArea
      const threshold = 5
      const isAtTop = scrollTop <= threshold
      const isAtBottom =
        scrollTop >=
        scrollHeight - clientHeight - threshold

      state.sidebarScrollArea.classList.toggle(
        'mask-t-from-90%',
        !isAtTop,
      )
      state.sidebarScrollArea.classList.toggle(
        'mask-b-from-90%',
        !isAtBottom,
      )
    }
  }

  class SidebarScroll {
    static toActive() {
      if (!state.scrollArea) return

      const activeItem =
        state.scrollArea.querySelector(
          '.subposts-sidebar-active-item',
        )
      if (!activeItem) {
        return
      }

      const { top: areaTop, height: areaHeight } =
        state.scrollArea.getBoundingClientRect()
      const { top: itemTop, height: itemHeight } =
        activeItem.getBoundingClientRect()

      const currentItemTop =
        itemTop -
        areaTop +
        state.scrollArea.scrollTop
      const targetScroll = Math.max(
        0,
        Math.min(
          currentItemTop -
            (areaHeight - itemHeight) / 2,
          state.scrollArea.scrollHeight -
            state.scrollArea.clientHeight,
        ),
      )

      state.scrollArea.scrollTop = targetScroll
    }
  }

  class SidebarController {
    static init() {
      state.reset()

      const sidebarContainer =
        document.getElementById(
          'subposts-sidebar-container',
        )
      if (sidebarContainer) {
        state.scrollArea =
          sidebarContainer.querySelector(
            '[data-radix-scroll-area-viewport]',
          )
        state.sidebarScrollArea =
          sidebarContainer.querySelector(
            '[data-subposts-sidebar-scroll]',
          )

        if (state.scrollArea) {
          state.scrollArea.addEventListener(
            'scroll',
            SidebarScrollMask.update,
            { passive: true },
          )
        }

        requestAnimationFrame(() => {
          SidebarScroll.toActive()
          setTimeout(
            SidebarScrollMask.update,
            100,
          )
        })
      }
    }

    static cleanup() {
      if (state.scrollArea) {
        state.scrollArea.removeEventListener(
          'scroll',
          SidebarScrollMask.update,
        )
      }
      state.reset()
    }
  }

  document.addEventListener(
    'astro:page-load',
    () => SidebarController.init(),
  )
  document.addEventListener(
    'astro:after-swap',
    () => {
      SidebarController.cleanup()
      SidebarController.init()
    },
  )
  document.addEventListener(
    'astro:before-swap',
    () => SidebarController.cleanup(),
  )
</script>
